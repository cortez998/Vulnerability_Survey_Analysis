rm(list=ls())

library(tidyverse)
library(ggplot2)
library(readxl)
library(mapview)
library(ggmap)
library(RColorBrewer)
library(dplyr)



wave1 <- read.csv("C:/Users/marco/OneDrive/Desktop/QDC/Challenge/data/final cleaning/brc-vulnerability-survey-wave-1_secondcleaning.csv")

#################### NEW MAP ####################################
worldmap = map_data('world')

ggplot() + 
  geom_polygon(data = worldmap, 
               aes(x = long, y = lat, 
                   group = group), 
               fill = 'gray90', 
               color = 'black') + 
  coord_fixed(ratio = 1.3, 
              xlim = c(-10,3), 
              ylim = c(50, 59))


#get the long and lat
unique(wave1$Nearest_City)
#regions we have in the dataset
regions <- c('Belfast', 'Brighton', 'London', 'Manchester', 'Glasgow', 'Leeds', 'Birmingham',
             'Cardiff', 'Plymouth', 'Norwich', 'Newcastle', 'Bristol', 'Liverpool',
             'Edinburgh', 'Sheffield', 'Southampton', 'Nottingham')

latlong <- geocode(wave1$Nearest_City)

#retrieve the coordinates of regions



#install.packages('RJSONIO')
library(RJSONIO)

unique_wave1 <- wave1[!duplicated(wave1[,c('Region','Nearest_City')]),]
nrow <- nrow(unique_wave1)
counter <- 1
unique_wave1$lon[counter] <- 0
unique_wave1$lat[counter] <- 0
while (counter <= nrow){
  CityName <- gsub(' ','%20',unique_wave1$Nearest_City[counter]) #remove space for URLs
  url <- paste(
    "http://nominatim.openstreetmap.org/search?city="
    , CityName
    , "&limit=9&format=json"
    , sep="")
  x <- fromJSON(url)
  if(is.vector(x)){
    unique_wave1$lon[counter] <- x[[1]]$lon
    unique_wave1$lat[counter] <- x[[1]]$lat    
  }
  counter <- counter + 1
}
unique_wave1$lat

#store the coordinates into the other df

wave1$lat <- NA
for (i in unique_wave1$Nearest_City){
  wave1$lat <- ifelse(wave1$Nearest_City == i, unique_wave1[unique_wave1$Nearest_City ==i,]$lat, wave1$lat) 
}

wave1$lon <- NA
for (i in unique_wave1$Nearest_City){
  wave1$lon <- ifelse(wave1$Nearest_City == i, unique_wave1[unique_wave1$Nearest_City ==i,]$lon, wave1$lon) 
}


coordinates <- wave1 %>% select(
  Nearest_City, Region, lat, lon
)

location_counts = wave1 %>% 
  group_by(Region, 
           Nearest_City) %>% 
  summarise(MoneyVulnerabilityIndex = mean(MoneyVulnerabilityIndex))

locations = location_counts %>%
  left_join(
    coordinates,
    by=c('Nearest_City','Region')
  )

locations <- unique(locations)


ggplot() + 
  geom_polygon(data = worldmap, 
               aes(x = long, y = lat, group = group), 
               fill = 'gray90', color = 'black') + 
  coord_fixed(ratio = 1.3, xlim = c(-10,3), ylim = c(50, 59)) + 
  geom_point(data = locations, 
             aes(x = as.numeric(lon), 
                 y = as.numeric(lat), size = MoneyVulnerabilityIndex, color = (MoneyVulnerabilityIndex), alpha = .8)) + 
  scale_size_area(max_size = 8) + 
  scale_color_viridis_c() + 
  # theme(legend.position = 'none') + 
  theme(title = element_text(size = 12))



##INDEX OF PHYSICAL## 
location_counts = wave1 %>% 
  group_by(Region, 
           Nearest_City) %>% 
  summarise(PhysicalVulnerabilityIndex = mean(PhysicalIndexVulnerabilityIndex))

locations = location_counts %>%
  left_join(
    coordinates,
    by=c('Nearest_City','Region')
  )

locations <- unique(locations)


ggplot() + 
  geom_polygon(data = worldmap, 
               aes(x = long, y = lat, group = group), 
               fill = 'gray90', color = 'black') + 
  coord_fixed(ratio = 1.3, xlim = c(-10,3), ylim = c(50, 59)) + 
  geom_point(data = locations, 
             aes(x = as.numeric(lon), 
                 y = as.numeric(lat), size = PhysicalVulnerabilityIndex, color = (PhysicalVulnerabilityIndex), alpha = .8)) + 
  scale_size_area(max_size = 8) + 
  scale_color_viridis_c() + 
  # theme(legend.position = 'none') + 
  theme(title = element_text(size = 12))



##INDEX OF MENTAL##
location_counts = wave1 %>% 
  group_by(Region, 
           Nearest_City) %>% 
  summarise(MentalVulnerabilityIndex = mean(MentalIndexVulnerabilityIndex))

locations = location_counts %>%
  left_join(
    coordinates,
    by=c('Nearest_City','Region')
  )

locations <- unique(locations)


ggplot() + 
  geom_polygon(data = worldmap, 
               aes(x = long, y = lat, group = group), 
               fill = 'gray90', color = 'black') + 
  coord_fixed(ratio = 1.3, xlim = c(-10,3), ylim = c(50, 59)) + 
  geom_point(data = locations, 
             aes(x = as.numeric(lon), 
                 y = as.numeric(lat), size = MentalVulnerabilityIndex, color = (MentalVulnerabilityIndex), alpha = .8)) + 
  scale_size_area(max_size = 8) + 
  scale_color_viridis_c() + 
  # theme(legend.position = 'none') + 
  theme(title = element_text(size = 12))


